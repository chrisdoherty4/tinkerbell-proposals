---
id: 0030
title: Configurable default CAPT templates and simplification of template overriding
status: discussion
authors: Chris Doherty <chris.doherty4@gmail.com>
---

# Configurable default CAPT templates and simplification of template overriding

## Context

When provisioning Kubernetes clusters with Cluster API Provider Tinkerbell (CAPT), CAPT will, by default, generate a Tinkerbell `Template` and submit it in conjunction with a `Workflow` to provision a node. 
It offers a template override feature that can be used to specify a template in full in place of the default template.

## Proposal

Firstly, allow operators to specify a default template by creating it in the cluster and referencing it CAPT configuration on launch or in a `ConfigMap`. 
This gives operators the ability to customize the default template that has to otherwise make assumptions on what to do when no template override is specified.

Secondly, replace the template override feature on `TinkerbellMachineTemplate`s with a reference field to a template. 
Using a reference field simplifies the CAPT API and enables re-use of templates when provisioning machines.

## Rationale

The default template generated by CAPT makes assumptions on how nodes are to be provisioned. 
It assumes images reside in an OCI registry, the operator does not wish to adjust cloud-init configuration, nodes are to be bootstrapped using cloud-init and that users wish to use kexec to launch the node bootstrap process. 
Allowing operators to specify a default gives operators better control over how nodes are provisioned without needing to specify overrides.

Template overrides are specified using a string field on the `TinkerbellMachineTemplate`.
The string field makes it difficult to understand the structure of the template and requires operators to understand how it's rendered to be confident the template is correct. 
We could change the field datatype to the Tinkerbell `Template` to make the structure clear but it wouldn't provide better re-use of templates in the context of Tinkerbell which is a core benefit. 
Using a template reference does require the client of CAPT to submit the template in addition to the other CAPT types and it will be necessary to move the templates between clusters during CAPI upgrades of management clusters. 

## Implementation

The [`TinkerbellMachineSpec`][tinkerbell-machine-spec] is a field on the `TinkerbellMachineTemplate`. 
Cluster API (CAPI) reads the `TinkerbellMachineSpec` from the `TinkerbellMachineTemplate` and creates a new `TinkerbellMachine` for every node to be provisioned. 
The `Image*` fields on the `TinkerbellMachineSpec` are used to construct URLs that populate the default template when a `TinkerbellMachine` is reconciled. 
These fields would no longer be required as CAPT wouldn't be responsible for constructing templates, only retrieving existing ones populated by end users. The 

**New `TinkerbellMachineSpec`**
```go
// TinkerbellMachineSpec defines the desired state of TinkerbellMachine.
type TinkerbellMachineSpec struct {
	// A reference to a Tinkerbell Template that will be checked at reconcile time for existence and 
    // used to render a Tinkerbell Workflow. If unspecified, the system attempts to use a default
    // template configured on CAPT launch. If no default template is specified reconciliation
    // will error and requeue until a template ref or default template is specified.
	// +optional
	TemplateRef corev1.ObjectReference `json:"templateRef,omitempty"`

	// HardwareAffinity allows filtering for hardware.
	// +optional
	HardwareAffinity *HardwareAffinity `json:"hardwareAffinity,omitempty"`

	// Those fields are set programmatically, but they cannot be re-constructed from "state of the world", so
	// we put them in spec instead of status.
	HardwareName string `json:"hardwareName,omitempty"`
	ProviderID   string `json:"providerID,omitempty"`
}
```

Additionally, the `TINKERBELL_IP` env var required when deploying CAPT with `clusterctl init` would no longer be required as its only necessary for rendering a default template.
On reconciliation of `TinkerbellMachine`s containing no `TemplateRef`, CAPT will search for a default template residing in a mounted `ConfigMap`.
If no default template is specified, CAPT will error and requeue the `TinkerbellMachine` until either the machine receives a `TemplateRef` or a default template is configured.
The default template will be optionally configured when invoking `clusterctl init` with a `TINKERBELL_DEFAULT_TEMPLATE=<namespace>:<name>` variable.


[tinkerbell-machine-spec]: https://github.com/tinkerbell/cluster-api-provider-tinkerbell/blob/46f1516b5140f8721dd57ca4ffed0379fde3f82c/api/v1beta1/tinkerbellmachine_types.go#L32